{
  "title": "k6 + PostgreSQL + App (Tomcat/JVM/Hikari) Overview",
  "schemaVersion": 38,
  "version": 1,
  "refresh": "5s",
  "time": { "from": "now-15m", "to": "now" },
  "editable": true,
  "timezone": "",
  "templating": {
    "list": [
      {
        "type": "datasource",
        "name": "DS_PROM",
        "label": "Prometheus",
        "query": "prometheus",
        "current": { "text": "Prometheus", "value": "Prometheus" }
      },
      {
        "type": "query",
        "name": "appJob",
        "label": "App job",
        "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
        "query": "label_values(up, job)",
        "includeAll": false,
        "refresh": 2
      },
      {
        "type": "query",
        "name": "dbname",
        "label": "DB Name",
        "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
        "query": "label_values(pg_stat_database_xact_commit, datname)",
        "current": { "text": "mumuk", "value": "mumuk" },
        "refresh": 2
      },
      {
        "type": "constant",
        "name": "appName",
        "label": "application_name (Postgres)",
        "query": "mumuk-api",
        "current": { "text": "mumuk-api", "value": "mumuk-api" }
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "type": "graph",
      "title": "RPS (http_reqs / 10s)",
      "datasource": "InfluxDB-k6",
      "targets": [
        { "refId": "A", "rawQuery": true, "resultFormat": "time_series", "query": "SELECT sum(\"value\") FROM \"http_reqs\" WHERE $timeFilter GROUP BY time(10s) fill(null)" }
      ],
      "gridPos": { "x": 0, "y": 0, "w": 12, "h": 8 },
      "lines": true
    },
    {
      "id": 2,
      "type": "graph",
      "title": "Response Time p95 (http_req_duration)",
      "datasource": "InfluxDB-k6",
      "targets": [
        { "refId": "A", "rawQuery": true, "resultFormat": "time_series", "query": "SELECT percentile(\"value\",95) FROM \"http_req_duration\" WHERE $timeFilter GROUP BY time(10s) fill(null)" }
      ],
      "gridPos": { "x": 12, "y": 0, "w": 12, "h": 8 },
      "lines": true
    },
    {
      "id": 3,
      "type": "graph",
      "title": "Fail Rate (http_req_failed)",
      "datasource": "InfluxDB-k6",
      "targets": [
        { "refId": "A", "rawQuery": true, "resultFormat": "time_series", "query": "SELECT mean(\"value\") FROM \"http_req_failed\" WHERE $timeFilter GROUP BY time(10s) fill(null)" }
      ],
      "gridPos": { "x": 0, "y": 8, "w": 12, "h": 8 },
      "lines": true
    },
    {
      "id": 4,
      "type": "graph",
      "title": "Signup / Login p95 (custom)",
      "datasource": "InfluxDB-k6",
      "targets": [
        { "refId": "A", "rawQuery": true, "resultFormat": "time_series", "query": "SELECT percentile(\"value\",95) FROM \"signup_duration\" WHERE $timeFilter GROUP BY time(10s) fill(null)" },
        { "refId": "B", "rawQuery": true, "resultFormat": "time_series", "query": "SELECT percentile(\"value\",95) FROM \"login_duration\" WHERE $timeFilter GROUP BY time(10s) fill(null)" }
      ],
      "gridPos": { "x": 12, "y": 8, "w": 12, "h": 8 },
      "lines": true,
      "legend": { "show": true }
    },

    {
      "id": 10,
      "type": "graph",
      "title": "PostgreSQL Active Connections (app=$appName)",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "pg_stat_activity_count{datname=\"$dbname\",state=\"active\",application_name=\"$appName\"}" }
      ],
      "gridPos": { "x": 0, "y": 16, "w": 12, "h": 7 },
      "lines": true
    },
    {
      "id": 11,
      "type": "graph",
      "title": "PostgreSQL Idle Connections (app=$appName)",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "pg_stat_activity_count{datname=\"$dbname\",state=\"idle\",application_name=\"$appName\"}" }
      ],
      "gridPos": { "x": 12, "y": 16, "w": 12, "h": 7 },
      "lines": true
    },
    {
      "id": 12,
      "type": "graph",
      "title": "PostgreSQL TPS (commit + rollback)",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "rate(pg_stat_database_xact_commit{datname=\"$dbname\"}[$__rate_interval]) + rate(pg_stat_database_xact_rollback{datname=\"$dbname\"}[$__rate_interval])" }
      ],
      "gridPos": { "x": 0, "y": 23, "w": 12, "h": 7 },
      "lines": true
    },
    {
      "id": 13,
      "type": "graph",
      "title": "PostgreSQL Cache Hit Ratio",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "pg_stat_database_blks_hit{datname=\"$dbname\"} / (pg_stat_database_blks_hit{datname=\"$dbname\"} + pg_stat_database_blks_read{datname=\"$dbname\"})" }
      ],
      "gridPos": { "x": 12, "y": 23, "w": 12, "h": 7 },
      "lines": true
    },
    {
      "id": 14,
      "type": "graph",
      "title": "PG Block I/O Time (ms/s)",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "rate(pg_stat_database_blk_read_time{datname=\"$dbname\"}[$__rate_interval])" },
        { "refId": "B", "expr": "rate(pg_stat_database_blk_write_time{datname=\"$dbname\"}[$__rate_interval])" }
      ],
      "gridPos": { "x": 0, "y": 30, "w": 12, "h": 7 },
      "lines": true,
      "legend": { "show": true }
    },
    {
      "id": 20,
      "type": "graph",
      "title": "HikariCP Connections (active / idle / pending)",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "sum(hikaricp_connections{job=\"springboot-backend\",state=\"active\"}) OR sum(hikaricp_connections_active{job=\"springboot-backend\"})" },
        { "refId": "B", "expr": "sum(hikaricp_connections{job=\"springboot-backend\",state=\"idle\"}) OR sum(hikaricp_connections_idle{job=\"springboot-backend\"})" },
        { "refId": "C", "expr": "sum(hikaricp_connections_pending{job=\"springboot-backend\"})" }
      ],
      "gridPos": { "x": 0, "y": 37, "w": 12, "h": 7 },
      "lines": true,
      "legend": { "show": true }
    },
    {
      "id": 21,
      "type": "graph",
      "title": "Tomcat Threads (current vs max)",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "sum(tomcat_threads_current_threads{job=\"springboot-backend\"})" },
        { "refId": "B", "expr": "sum(tomcat_threads_config_max_threads{job=\"springboot-backend\"})" }
      ],
      "gridPos": { "x": 12, "y": 37, "w": 12, "h": 7 },
      "lines": true,
      "legend": { "show": true }
    },
    {
      "id": 22,
      "type": "graph",
      "title": "HTTP Server – Request rate (req/s)",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "sum(rate(http_server_requests_seconds_count{job=\"springboot-backend\"}[$__rate_interval]))" }
      ],
      "gridPos": { "x": 0, "y": 44, "w": 12, "h": 7 },
      "lines": true
    },
    {
      "id": 23,
      "type": "graph",
      "title": "HTTP Server p95 (requires *_bucket)",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "histogram_quantile(0.95, sum by (le) (rate(http_server_requests_seconds_bucket{job=\"springboot-backend\"}[$__rate_interval])))" }
      ],
      "gridPos": { "x": 12, "y": 44, "w": 12, "h": 7 },
      "lines": true
    },
    {
      "id": 24,
      "type": "graph",
      "title": "HTTP Server – Avg latency (seconds) [fallback]",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "sum(rate(http_server_requests_seconds_sum{job=\"springboot-backend\"}[$__rate_interval])) / sum(rate(http_server_requests_seconds_count{job=\"springboot-backend\"}[$__rate_interval]))" }
      ],
      "gridPos": { "x": 0, "y": 51, "w": 12, "h": 7 },
      "lines": true
    },
    {
      "id": 30,
      "type": "graph",
      "title": "JVM GC Pause (seconds/s)",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "rate(jvm_gc_pause_seconds_sum{job=\"springboot-backend\"}[$__rate_interval])" }
      ],
      "gridPos": { "x": 12, "y": 51, "w": 12, "h": 7 },
      "lines": true
    },
    {
      "id": 31,
      "type": "graph",
      "title": "JVM Heap Used vs Max (bytes)",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "sum(jvm_memory_used_bytes{job=\"springboot-backend\",area=\"heap\"})" },
        { "refId": "B", "expr": "sum(jvm_memory_max_bytes{job=\"springboot-backend\",area=\"heap\"})" }
      ],
      "gridPos": { "x": 0, "y": 58, "w": 12, "h": 7 },
      "lines": true,
      "legend": { "show": true }
    },
    {
      "id": 32,
      "type": "graph",
      "title": "JVM Threads (live / peak)",
      "datasource": "Prometheus",
      "targets": [
        { "refId": "A", "expr": "sum(jvm_threads_live_threads{job=\"springboot-backend\"})" },
        { "refId": "B", "expr": "sum(jvm_threads_peak_threads{job=\"springboot-backend\"})" }
      ],
      "gridPos": { "x": 12, "y": 58, "w": 12, "h": 7 },
      "lines": true,
      "legend": { "show": true }
    }
  ]
}
